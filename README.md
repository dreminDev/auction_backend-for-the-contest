# auction_backend-for-the-contest

Backend система для проведения аукционов с поддержкой многораундовых ставок и автоматической выдачей подарков.

## Реализованная функциональность

### Система аукционов

- Создание аукционов с настраиваемым количеством раундов
- Автоматическое распределение подарков по раундам
- Обработка окончания раундов через воркеры
- Переход проигравших ставок в следующий раунд
- Автоматический возврат баланса при завершении последнего раунда

### Система ставок

- Размещение ставок в текущем раунде
- Автоматическое продление раунда при ставках в последние 10 секунд
- Массовое обновление ставок при переходе в следующий раунд
- Массовый возврат баланса проигравшим участникам

### Система подарков

- Уникальная нумерация подарков (серийные номера)
- Массовая выдача подарков победителям раунда
- Проверка наличия подарков в коллекции
- Автоматическое распределение по раундам

### Система балансов

- Управление балансами пользователей
- Транзакционная обработка операций
- Логирование всех операций с балансом
- Поддержка различных типов балансов

### Антиснифинг

- Защита от манипуляций со ставками
- Валидация времени окончания раундов
- Транзакционная целостность операций
- Мьютексы для предотвращения гонок данных

### Архитектура

- Dependency Injection (DI) для управления зависимостями
- Разделение на слои: репозитории, сервисы, контроллеры
- Поддержка транзакций на уровне репозиториев
- Воркеры для фоновых задач
- Структурированное логирование

## Логика работы системы

### Создание аукциона

При создании аукциона указываются следующие параметры:
- `roundCount` - количество раундов (1-100)
- `roundDuration` - длительность одного раунда в миллисекундах (минимум 5000)
- `supplyCount` - общее количество подарков для раздачи
- `giftCollectionId` - идентификатор коллекции подарков

Подарки автоматически распределяются между раундами равномерно. Например, при 10 подарках и 3 раундах:
- Раунд 1: 4 подарка
- Раунд 2: 3 подарка
- Раунд 3: 3 подарка

Аукцион создается со статусом `active` и начинает первый раунд.

### Система ставок

#### Размещение ставки

При размещении ставки происходит следующее:

1. **Проверка аукциона**: Аукцион должен быть активным и раунд не должен быть завершен
2. **Проверка баланса**: У пользователя должно быть достаточно средств
3. **Проверка времени**: Ставка не может быть размещена после окончания времени раунда
4. **Проверка перебивающей ставки**: Ставка должна быть больше последней выигрывающей ставки

#### Логика перебивающей ставки

Ставка считается перебивающей, если она больше последней выигрывающей ставки в текущем раунде.

**Пример**: Если в раунде 10 призовых мест и есть 100 ставок:
- Ставки сортируются по убыванию суммы
- Последняя выигрывающая ставка находится на позиции 10 (индекс 9)
- Новая ставка должна быть больше этой ставки
- Если последняя выигрывающая ставка = 100, то новая ставка должна быть минимум 101

Если у пользователя уже есть ставка в текущем раунде, то проверяется итоговая сумма (текущая ставка + новая сумма).

Если ставок меньше, чем призовых мест, проверка не выполняется - можно делать любую ставку.

#### Продление раунда (антиснифинг система)

Если ставка размещается в последние 10 секунд до окончания раунда, раунд автоматически продлевается на 10 секунд от текущего момента. Это предотвращает снифинг (ставки в последний момент).

**Пример**: 
- Раунд должен закончиться в 12:00:00
- Ставка размещена в 11:59:55 (осталось 5 секунд)
- Раунд продлевается до 12:00:05

#### Обновление ставки

Если у пользователя уже есть ставка в текущем раунде:
- Новая сумма добавляется к существующей ставке
- Ставка обновляется в базе данных
- Баланс уменьшается на сумму новой ставки

Если ставки нет:
- Создается новая ставка
- Баланс уменьшается на сумму ставки

### Завершение раунда

Воркер периодически проверяет активные аукционы и завершает раунды, у которых истекло время.

#### Обработка ставок

1. **Получение ставок**: Получаются все ставки текущего раунда
2. **Расчет призовых мест**: Вычисляется количество призовых мест для текущего раунда
3. **Сортировка**: Ставки сортируются по убыванию суммы
4. **Разделение на winners и losers**:
   - `winners` - первые N ставок (где N = количество призовых мест)
   - `losers` - остальные ставки

#### Обработка выигравших ставок (winners)

1. **Выдача подарков**: Победителям выдаются подарки с уникальными серийными номерами
2. **Удаление ставок**: Выигравшие ставки удаляются из базы данных
3. **Важно**: Пользователи, выигравшие в текущем раунде, могут делать новые ставки в следующих раундах, но их выигравшая ставка не переносится

#### Обработка проигравших ставок (losers)

**Если есть следующий раунд:**
1. Ставки переводятся в следующий раунд (обновляется поле `round`)
2. Аукцион переходит к следующему раунду
3. Устанавливается новое время начала и окончания раунда

**Если это последний раунд:**
1. Баланс возвращается проигравшим участникам
2. Ставки удаляются из базы данных
3. Аукцион помечается как завершенный (`status: "ended"`)

#### Особые случаи

- **Нет ставок или ставок меньше призовых мест**: Раунд продлевается на 5 минут
- **Все ставки выиграли**: Аукцион переходит к следующему раунду (если он есть) или завершается

### Транзакционная целостность

Все операции выполняются в транзакциях для обеспечения целостности данных:
- Снятие баланса и создание ставки - одна транзакция
- Выдача подарков и удаление ставок - одна транзакция
- Возврат баланса и удаление ставок - одна транзакция

При конфликтах транзакций выполняется повторная попытка (до 5 раз) с экспоненциальной задержкой.

### Мьютексы

Для предотвращения одновременной обработки одного и того же аукциона используется мьютекс. Это гарантирует, что воркер не обработает один аукцион дважды одновременно.

### Логирование операций

Все операции с балансом логируются в таблицу `Action`:
- Тип операции (`bet`, `balance`)
- Старая и новая сумма баланса
- Метаданные операции (ID аукциона, сумма ставки и т.д.)

## Допущения которые были

- После создания ставки можно было возвращать ставки дабы улучшить синхронизированность между серверами
- По хорошему реализация должна быть выполнена была на вебсокетах для более быстрого реагирования на ставки
